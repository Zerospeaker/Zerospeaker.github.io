<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="我们知道在C语言中字符串字面量隐式地以’\0’结尾，许多C函数（如strcmp）也依赖这样的字符串格式，即便输入不是字面量而是在一个char数组中。&lt;br&gt;而在C++中string却不一定以’\0’结尾，因为string实现有size标识现在的字符数目，因此string是可以包含’\0’的。&lt;br&gt;为了支持string到C风格字符串的转换，C++ string提供了c_str和data成员函数。我们来测试一下这些函数在string包含’\0’时会发生什么。&lt;br&gt;代码如下：  "><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>关于C++ string存储'\0'的几点注意 | Hickey</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.2"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a><a class="sidebar-nav-item" href="/about">About</a></nav><div class="container post-meta"><div class="post-time">2022-04-09</div> </div></div><div class="container post-header"><p class="post-title" align="center">关于C++ string存储'\0'的几点注意</p></div><hr class="_title_line"><div class="container post-content"><p>我们知道在C语言中字符串字面量隐式地以’\0’结尾，许多C函数（如strcmp）也依赖这样的字符串格式，即便输入不是字面量而是在一个char数组中。<br>而在C++中string却不一定以’\0’结尾，因为string实现有size标识现在的字符数目，因此string是可以包含’\0’的。<br>为了支持string到C风格字符串的转换，C++ string提供了c_str和data成员函数。我们来测试一下这些函数在string包含’\0’时会发生什么。<br>代码如下：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span></span>&#123;</span><br><span class="line">    string s;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">8</span>] = &#123;<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>&#125;; <span class="comment">// 包含空字符的字符数组</span></span><br><span class="line">    s += <span class="string">&quot;188&quot;</span>;  <span class="comment">// 等同于s.append(&quot;字符串字面量&quot;);</span></span><br><span class="line">    s += <span class="string">&#x27;\0&#x27;</span>;  <span class="comment">// 等同于s.push_back(&#x27;\0&#x27;);</span></span><br><span class="line">    s += <span class="string">&quot;aa&quot;</span>;</span><br><span class="line">    s += <span class="string">&quot;&quot;</span>;</span><br><span class="line">    s.<span class="built_in">append</span>(buf, <span class="number">8</span>);</span><br><span class="line">    <span class="type">int</span> len = s.<span class="built_in">length</span>();</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;size of s: &quot;</span> &lt;&lt; len &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;string: &quot;</span> &lt;&lt; s &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;c_str: &quot;</span> &lt;&lt; s.<span class="built_in">c_str</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;data: &quot;</span> &lt;&lt; s.<span class="built_in">data</span>() &lt;&lt; endl;</span><br><span class="line">    <span class="function">ofstream <span class="title">outputFile</span><span class="params">(<span class="string">&quot;teststring&quot;</span>)</span></span>;</span><br><span class="line">    <span class="comment">// outputFile.write(&amp;s[0], len);</span></span><br><span class="line">    outputFile.<span class="built_in">write</span>(s.<span class="built_in">c_str</span>(), len);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出如下：  </p>
<p><img src="https://hickey-image.oss-cn-shanghai.aliyuncs.com/image/202204090104888.png" alt="image-20220409010411620"></p>
<p>这意味着，向string中插入单个’\0’字符是可以的，而且人为插入的’\0’字符算string的长度，但字符串字面量中的’\0’却不会被插入到string中，这也说明了’\0’和””的区别。同时我们可以向string插入包含’\0’字符的字符序列，只要指定长度就好了（因为字符串字面量没有长度属性，只好通过’\0’字符判断结束）。</p>
<p>在C++17之前，c_str和data没什么不同，只是C++17之后多了一个非const成员函数的重载，这意味着对没有指定const限定符的string的data函数调用将使用非const的版本，库代码如下：     </p>
<p><img src="https://hickey-image.oss-cn-shanghai.aliyuncs.com/image/202204090046671.png" alt="image-20220409004634388"></p>
<p>虽然从标准输出来看，c_str和data都被string内含的’\0’截断（这个’\0’是我们自己向string中插入的），但我们的测试代码中无论是1还是2处，我们都可以获取到string中包含的真实内容，我们通过将string输出到文件中而不是控制台显示这点：  </p>
<p><img src="https://hickey-image.oss-cn-shanghai.aliyuncs.com/image/202204090104862.png" alt="image-20220409010445645"></p>
<p>上面是输出文件的内容，1处和2处代码的效果是相同的。我们看到string中的空字符也被输出到文件中（红色的NVL），因为我们在输出时指定了len字段，这将不会使用’\0’作为结束的判断。</p>
<p>因此，我们可以通过string存储二进制数据（通常会包含’\0’字符），也可以通过c_str或data取出只读数据，而对这两个函数返回的const char*的处理，却决于我们如何对待它。如果我们把它当作C风格字符串，那么我们就失去了处理二进制的能力，但是通过string.length我们可以获取字符串的真实长度（包含’\0’），这样我们就可以利用这个长度作为处理的结束判断，也就有了处理二进制数据的能力。</p>
</div></div><div class="post-main post-comment"><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'hickey-1';
var disqus_identifier = '2022/04/09/关于C++ string存储空字符0的几点注意/';
var disqus_title = '关于C++ string存储'\0'的几点注意';
var disqus_url = 'http://hickey.ltd/2022/04/09/%E5%85%B3%E4%BA%8EC++%20string%E5%AD%98%E5%82%A8%E7%A9%BA%E5%AD%97%E7%AC%A60%E7%9A%84%E5%87%A0%E7%82%B9%E6%B3%A8%E6%84%8F/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a target="_blank" rel="noopener" href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcdn.net/ajax/libs/font-awesome/5.15.3/css/all.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcdn.net/ajax/libs/lato-font/3.0.0/css/lato-font.min.css"><link rel="stylesheet" type="text/css" href="/css/number_title.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcdn.net/ajax/libs/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcdn.net/ajax/libs/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcdn.net/ajax/libs/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>